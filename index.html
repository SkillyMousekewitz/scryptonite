<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scryptonite | Screenwriter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
/* --- UPDATED INFINITE PAPER CSS --- */
#script-container { 
    display: block; /* Switched back for better margin control */
    margin: 0 auto 400px auto;
    width: 8.5in; 
    min-height: 11in; 
    height: auto !important; 
    background-color: #f0f2f5; /* The "Desk" color */
    
    /* This creates the look of stacked sheets of paper with gaps */
    background-image: 
        linear-gradient(to bottom, #ffffff 10.7in, transparent 10.7in, transparent 11in);
    background-size: 100% 11in;
    background-repeat: repeat-y;
    
    /* Internal Page Margins (First Page) */
    padding: 1in 1in 1in 1.5in; 
    
    font-family: 'Courier Prime', Courier, monospace; 
    font-size: 12pt; 
    line-height: 1.2; /* Critical for alignment */
    outline: none;
    color: #000;
    box-sizing: border-box;
    position: relative;
}

/* Ensure the white "Paper" effect stays under the text */
#script-container::before {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: -1;
    background-color: white;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

/* SCRIPT ELEMENT FORMATTING (Ensuring it sticks on all pages) */
.line { 
    min-height: 1.2em; 
    outline: none; 
    position: relative; 
    margin: 0; 
    width: 100%;
}

.scene-heading { text-transform: uppercase; font-weight: bold; margin-top: 24pt; } /* 2 lines of space */
.action { margin-top: 12pt; } /* 1 line of space */
.character { margin-left: 2in; width: 4in; margin-top: 12pt; text-transform: uppercase; }
.parenthetical { margin-left: 1.5in; width: 2.5in; }
.dialogue { margin-left: 1in; width: 3.5in; margin-bottom: 0; }
.transition { text-transform: uppercase; margin-left: 4.5in; margin-top: 12pt; }

/* The "Gap" effect to prevent text from hitting the line */
.line::after {
    content: "";
    display: block;
    height: 0;
}
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="card p-5 shadow-lg text-center" style="width: 400px; border-radius: 20px;">
            <h1 style="font-weight: 800; letter-spacing: -1px;">SCRYPT<span style="color:var(--accent)">ONITE</span></h1>
            <button id="login-btn" class="btn btn-dark w-100 py-3 mt-4">Sign in with Google</button>
        </div>
    </div>

    <div id="legend-overlay" style="display:none;" onclick="toggleLegend()">
        <div class="card bg-dark text-white p-4 border-secondary shadow-lg" style="width: 450px;" onclick="event.stopPropagation()">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-info">COMMANDS</h5>
                <button class="btn-close btn-close-white" onclick="toggleLegend()"></button>
            </div>
            <table class="table table-dark table-hover mb-0" style="font-size: 0.9rem;">
                <tbody>
                    <tr><td><kbd>Tab</kbd></td><td>Cycle Elements</td></tr>
                    <tr><td><kbd>Enter</kbd></td><td>Smart Next Line</td></tr>
                    <tr><td><kbd>Ctrl + \</kbd></td><td>Focus Mode (Hide UI)</td></tr>
                    <tr><td><kbd>Ctrl + /</kbd></td><td>Show Help</td></tr>
                    <tr><td><kbd>Ctrl + Shift + N</kbd></td><td>Add Script Note</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="left-sidebar">
        <h6 class="mb-3 text-muted">SCENES</h6>
        <div id="scene-list" class="flex-grow-1 overflow-auto mb-3"></div>
        <div class="small mb-3">
            Pages: <span id="stat-pages">1</span><br>
            Words: <span id="stat-words">0</span><br>
            Runtime: <span id="stat-time">0m 0s</span>
        </div>
        <div class="d-grid gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="toggleDarkMode()">Theme</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="toggleFocusMode()">Focus</button>
            <button class="btn btn-outline-warning btn-sm" onclick="saveVersion()">Snapshot</button>
            <button class="btn btn-outline-info btn-sm" onclick="toggleLegend()">Help</button>
            <button class="btn btn-success btn-sm" onclick="exportToPDF()">Export PDF</button>
            <button class="btn btn-link btn-sm text-danger mt-3" onclick="signOutUser()">Sign Out</button>
        </div>
    </div>

    <div id="main-editor">
        <div id="script-container" contenteditable="true" spellcheck="true">
            <div class="line scene-heading" data-type="scene-heading">&#8203;</div>
        </div>
    </div>

    <div id="right-sidebar">
        <div class="btn-group mb-3 w-100">
            <button id="btn-beats" class="btn btn-sm btn-info" onclick="switchTab('beats')">BEATS</button>
            <button id="btn-chars" class="btn btn-sm btn-outline-info" onclick="switchTab('chars')">CHARS</button>
        </div>
        <div id="tab-beats"><div id="beat-container" contenteditable="true" class="story-box"><b>STORY BEATS:</b><br>• </div></div>
        <div id="tab-chars" style="display:none;"><div id="char-container" contenteditable="true" class="story-box"><b>CHARACTERS:</b><br>• </div></div>
    </div>

    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

// --- FIREBASE CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyCMJ8mkBdyhLDbC6RmaVK9zWl-XSms6RoA",
    authDomain: "scryptonite-6a340.firebaseapp.com",
    projectId: "scryptonite-6a340",
    storageBucket: "scryptonite-6a340.firebasestorage.app",
    messagingSenderId: "875468928578",
    appId: "1:875468928578:web:524ae574d4c84593a49fdb",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
let currentUser = null;

const container = document.getElementById('script-container');
const beatsBox = document.getElementById('beat-container');
const charsBox = document.getElementById('char-container');
const elements = ["scene-heading", "action", "character", "parenthetical", "dialogue", "transition"];

// --- AUTHENTICATION ---
document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider);
window.signOutUser = () => signOut(auth);

onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        document.getElementById('auth-overlay').style.display = 'none';
        startSync(user.uid);
    } else {
        document.getElementById('auth-overlay').style.display = 'flex';
    }
});

// --- KEYBOARD ENGINE (REFINED FOR MARGINS & PAGING) ---
document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && (e.key === '/' || e.code === 'Slash')) { e.preventDefault(); toggleLegend(); return; }
    if (e.ctrlKey && e.key === '\\') { e.preventDefault(); toggleFocusMode(); return; }
    
    if (!container.contains(document.activeElement)) return;

    const sel = window.getSelection();
    const line = sel.anchorNode?.nodeType === 3 ? sel.anchorNode.parentElement.closest('.line') : sel.anchorNode.closest('.line');
    
    // TAB: Cycle Elements with Cursor Anchor
    if (e.key === 'Tab') {
        e.preventDefault();
        if (!line) return;
        
        const offset = sel.anchorOffset;
        if (!line.innerText.trim()) line.innerHTML = "&#8203;"; 

        let idx = elements.indexOf(line.dataset.type);
        idx = e.shiftKey ? (idx - 1 + elements.length) % elements.length : (idx + 1) % elements.length;
        line.className = `line ${elements[idx]}`;
        line.dataset.type = elements[idx];
        
        const range = document.createRange();
        const node = line.firstChild || line;
        range.setStart(node, Math.min(offset, node.length || 0));
        range.collapse(true);
        sel.removeAllRanges(); sel.addRange(range);
        updateNavigator();
        return;
    }

    // ENTER: Smart Transition & Formatting Persistence
    if (e.key === 'Enter') {
        e.preventDefault();
        if (!line) return;
        
        const type = line.dataset.type;
        const nextType = { 
            "character": "dialogue", 
            "scene-heading": "action", 
            "dialogue": "action", 
            "parenthetical": "dialogue" 
        }[type] || "action";
        
        const newLine = document.createElement('div');
        newLine.className = `line ${nextType}`;
        newLine.dataset.type = nextType;
        newLine.innerHTML = "&#8203;"; 
        line.after(newLine);

        const range = document.createRange();
        range.setStart(newLine.firstChild, 0);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);

        // Keep page breaks clean
        newLine.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        updateStats();
        return;
    }

    if (e.ctrlKey && e.shiftKey && e.key === 'N') {
        e.preventDefault();
        if (line) insertNote(line);
    }
});

// --- CLOUD SYNC & STATS ENGINE ---
[container, beatsBox, charsBox].forEach(box => {
    box.addEventListener('input', () => {
        if (box === container) autoCapitalize();
        updateStats();
        saveToCloud();
    });
});

async function saveToCloud() {
    if (currentUser) {
        await setDoc(doc(db, "scripts", currentUser.uid), {
            content: container.innerHTML,
            beats: beatsBox.innerHTML,
            chars: charsBox.innerHTML
        }, { merge: true });
    }
}

function startSync(uid) {
    onSnapshot(doc(db, "scripts", uid), (snap) => {
        if (snap.exists()) {
            const data = snap.data();
            if (document.activeElement !== container) {
                container.innerHTML = data.content || "";
                updateNavigator();
                updateStats();
            }
            if (document.activeElement !== beatsBox) beatsBox.innerHTML = data.beats || "<b>BEAT SHEET:</b>";
            if (document.activeElement !== charsBox) charsBox.innerHTML = data.chars || "<b>CHARACTERS:</b>";
        }
    });
}

// --- UI HELPERS ---
window.toggleLegend = () => {
    const leg = document.getElementById('legend-overlay');
    leg.style.display = (leg.style.display === 'none' || leg.style.display === '') ? 'flex' : 'none';
};

window.toggleDarkMode = () => document.body.classList.toggle('dark-mode');
window.toggleFocusMode = () => document.body.classList.toggle('focus-mode');

window.switchTab = (tab) => {
    document.getElementById('tab-beats').style.display = tab === 'beats' ? 'block' : 'none';
    document.getElementById('tab-chars').style.display = tab === 'chars' ? 'block' : 'none';
    document.getElementById('btn-beats').className = tab === 'beats' ? 'btn btn-sm btn-info' : 'btn btn-sm btn-outline-info';
    document.getElementById('btn-chars').className = tab === 'chars' ? 'btn btn-sm btn-info' : 'btn btn-sm btn-outline-info';
};

function autoCapitalize() {
    const sel = window.getSelection();
    const line = sel.anchorNode?.nodeType === 3 ? sel.anchorNode.parentElement.closest('.line') : sel.anchorNode.closest('.line');
    if (line && (line.dataset.type === 'character' || line.dataset.type === 'scene-heading')) {
        const pos = sel.anchorOffset;
        line.innerText = line.innerText.toUpperCase();
        const range = document.createRange();
        if (line.firstChild) {
            range.setStart(line.firstChild, Math.min(pos, line.innerText.length));
            range.collapse(true);
            sel.removeAllRanges(); sel.addRange(range);
        }
    }
}

function updateNavigator() {
    const list = document.getElementById('scene-list');
    list.innerHTML = "";
    container.querySelectorAll('.scene-heading').forEach((s) => {
        const item = document.createElement('div');
        item.className = 'nav-item mb-1';
        item.innerText = s.innerText.trim() || "NEW SCENE";
        item.onclick = () => s.scrollIntoView({ behavior: 'smooth' });
        list.appendChild(item);
    });
}

function updateStats() {
    const words = container.innerText.trim().split(/\s+/).length;
    // Calculate pages based on 1056px (11 inches) increments
    const pages = Math.max(1, Math.ceil(container.offsetHeight / 1056)); 
    document.getElementById('stat-pages').innerText = pages;
    document.getElementById('stat-words').innerText = words;
    document.getElementById('stat-time').innerText = `${pages}m 00s`;
}

window.exportToPDF = () => {
    const opt = { margin: [1, 1, 1, 1.5], filename: 'script.pdf', jsPDF: { unit: 'in', format: 'letter' } };
    html2pdf().set(opt).from(container).save();
};

window.saveVersion = async () => {
    const name = prompt("Name this snapshot:");
    if (!name) return;
    await addDoc(collection(db, "scripts", currentUser.uid, "snapshots"), {
        name, content: container.innerHTML, timestamp: new Date()
    });
    alert("Snapshot saved!");
};

function insertNote(line) {
    const note = document.createElement('div');
    note.className = 'script-note';
    note.contentEditable = true;
    note.innerText = "[ NOTE ]";
    line.after(note);
}
    </script>
</body>
</html>
